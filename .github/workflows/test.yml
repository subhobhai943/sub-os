name: Test SUB OS

on:
  push:
    branches: [ main, arm-port ]
  pull_request:
    branches: [ main, arm-port ]

jobs:
  compile-test:
    name: Compilation Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential nasm xorriso
    
    - name: Clean build
      run: make clean || true
    
    - name: Build bootloader
      run: |
        mkdir -p build
        nasm -f bin boot/boot.asm -o build/boot.bin
        echo "Bootloader compiled successfully"
    
    - name: Build kernel objects
      run: make || true
    
    - name: Check for compilation errors
      run: |
        if [ -f build/sub_os.bin ] && [ -f build/sub_os.img ] && [ -f build/sub_os.iso ]; then
          echo "✓ Build successful!"
          exit 0
        else
          echo "✗ Build failed"
          exit 1
        fi

  compile-test-arm:
    name: Compilation Test (ARM)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc-arm-none-eabi
    
    - name: Clean build
      run: make clean || true
    
    - name: Build
      run: make TARGET_ARCH=arm CC=arm-none-eabi-gcc LD=arm-none-eabi-ld ASM=arm-none-eabi-as
    
    - name: Check for compilation errors
      run: |
        if [ -f build/sub_os.elf ]; then
          echo "✓ Build successful!"
          exit 0
        else
          echo "✗ Build failed"
          exit 1
        fi

  size-check:
    name: Binary Size Check
    runs-on: ubuntu-latest
    needs: compile-test
    
    steps:
    - uses: actions/checkout@v3
    - run: sudo apt-get update && sudo apt-get install -y build-essential nasm xorriso
    - run: make
    
    - name: Check binary sizes
      run: |
        echo "=== Binary Sizes ==="
        echo "Bootloader: $(stat -c%s build/boot.bin) bytes (max 512)"
        echo "Kernel: $(stat -c%s build/kernel.bin) bytes"
        echo "Total OS: $(stat -c%s build/sub_os.bin) bytes"
        echo "Floppy image: $(stat -c%s build/sub_os.img) bytes"
        echo "ISO image: $(stat -c%s build/sub_os.iso) bytes"
        
        BOOT_SIZE=$(stat -c%s build/boot.bin)
        if [ $BOOT_SIZE -gt 512 ]; then
          echo "ERROR: Bootloader exceeds 512 bytes!"
          exit 1
        fi
        echo "✓ Bootloader size OK"

  qemu-test:
    name: QEMU Boot Test
    runs-on: ubuntu-latest
    needs: compile-test
    
    steps:
    - uses: actions/checkout@v3
    - run: sudo apt-get update && sudo apt-get install -y build-essential nasm qemu-system-x86 xorriso
    - run: make
    
    - name: Boot test
      run: |
        echo "Testing OS boot in QEMU..."
        timeout 15 qemu-system-i386 \
          -drive format=raw,file=build/sub_os.bin \
          -m 128M \
          -nographic \
          -serial file:boot.log \
          || true
        
        echo "=== Boot Log ==="
        cat boot.log || echo "No boot log generated"
        
        if grep -q "SUB OS" boot.log; then
          echo "✓ OS booted successfully!"
        else
          echo "⚠ Boot may have issues"
        fi

  qemu-test-arm:
    name: QEMU Boot Test (ARM)
    runs-on: ubuntu-latest
    needs: compile-test-arm
    
    steps:
    - uses: actions/checkout@v3
    - run: sudo apt-get update && sudo apt-get install -y build-essential gcc-arm-none-eabi qemu-system-arm
    - run: make TARGET_ARCH=arm CC=arm-none-eabi-gcc LD=arm-none-eabi-ld ASM=arm-none-eabi-as
    
    - name: Boot test
      run: |
        echo "Testing OS boot in QEMU (ARM)..."
        timeout 15 qemu-system-arm \
          -M virt -cpu cortex-a15 \
          -nographic \
          -kernel build/sub_os.elf \
          > boot.log 2>&1 \
          || true
        
        echo "=== Boot Log ==="
        cat boot.log || echo "No boot log generated"
        
        if grep -q "SUB OS" boot.log; then
          echo "✓ OS booted successfully!"
        else
          echo "⚠ Boot may have issues"
        fi